# ============================================================================
# ProFTPD Configuration with MongoDB Authentication Module
# ============================================================================
#
# This configuration demonstrates MongoDB-based authentication with user
# jailing (chroot) to their home directory using their own uid/gid.
#
# PREREQUISITES:
# 1. ProFTPD compiled with --enable-dso
# 2. mod_auth_mongodb.so installed in libexec directory
# 3. MongoDB server accessible with user collection set up
# 4. User home directories created with proper ownership
#
# QUICK START:
# 1. Replace MongoDB connection string with your actual values
# 2. Adjust field names if your MongoDB schema differs
# 3. Optional: Adjust AuthMongoConnectionPoolSize for your load (default: 10)
# 4. Create user home directories: mkdir -p /home/username
# 5. Set ownership: chown username:groupname /home/username
# 6. Test configuration: proftpd -t -c /etc/proftpd/proftpd.conf
# 7. Restart: systemctl restart proftpd

# ============================================================================
# BASIC SERVER CONFIGURATION
# ============================================================================

# Server identity shown to clients
ServerName                      "ProFTPD with MongoDB Auth"

# Run as standalone daemon (not from inetd)
ServerType                      standalone

# This is the primary/default server
DefaultServer                   on

# FTP control port (2222 for SFTP, 21 is standard FTP)
Port                            2222

# Don't use IPv6 support by default.
UseIPv6                         off

# Default file creation mask (files created as 644, dirs as 755)
Umask                           022

# Maximum number of simultaneous connections
# IMPORTANT: For parallel SFTP uploads, set this to at least 2x your expected
# concurrent users. Each SFTP client may open 5-10 parallel connections.
# Example: 10 concurrent users × 10 connections = 100 needed
# Recommended: 50-100 for production SFTP servers
MaxInstances                    100

# User/group for main daemon process (NOT for authenticated users)
# The daemon drops privileges after binding to port
User                            nobody
Group                           nogroup

# Jail all users to their home directory
# The ~ means each user's home directory (from AuthMongoDocumentFieldPath)
# Users cannot navigate above their home directory - they see it as /
DefaultRoot                     ~

# Normally, we want files to be overwriteable.
AllowOverwrite                  on

# Bar use of SITE CHMOD by default
<Limit SITE_CHMOD>
  DenyAll
</Limit>

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================

# System log for errors, auth failures, debugging
SystemLog                       /var/log/proftpd/system.log

# Transfer log for file upload/download activity
TransferLog                     /var/log/proftpd/xferlog

# ============================================================================
# MONGODB AUTHENTICATION MODULE
# ============================================================================

# Load the MongoDB authentication module (must be first!)
ModulePath /usr/local/libexec
LoadModule mod_auth_mongodb.c

# --- MongoDB Connection Settings ---

# Full MongoDB connection URI (supports replica sets, auth, timeouts)
# Format: mongodb://[username:password@]host1[:port1][,host2[:port2],...][/[defaultauthdb][?options]]
#
# SECURITY BEST PRACTICE - Use environment variables for passwords:
# Instead of hardcoding passwords, use ${VAR_NAME} syntax to reference environment variables.
# This prevents committing credentials to version control.
#
# Example with environment variable:
#   AuthMongoConnectionString "mongodb://admin:${MONGO_PASSWORD}@localhost:27017/?authSource=admin"
#
# Then set the environment variable before starting ProFTPD:
#   export MONGO_PASSWORD="your_secure_password_here"
#   systemctl start proftpd
#
# Or add to /etc/default/proftpd (Debian/Ubuntu) or /etc/sysconfig/proftpd (RHEL/CentOS):
#   MONGO_PASSWORD="your_secure_password_here"
#
# REQUIRED: Replace with your actual MongoDB connection details
# The example below shows a replica set configuration with environment variable for password
AuthMongoConnectionString       "mongodb://username:${MONGO_PASSWORD}@mongo1.vm.lan:27017,mongo2.vm.lan:27017,mongo3.vm.lan:27017/?retryWrites=true&replicaSet=rs0&readPreference=primary&serverSelectionTimeoutMS=5000&connectTimeoutMS=10000&authSource=admin&authMechanism=SCRAM-SHA-256"

# Database name containing user collection
# REQUIRED: Replace with your database name
AuthMongoDatabaseName           "authentication"

# Collection name containing user documents
# REQUIRED: Replace with your collection name
AuthMongoAuthCollectionName     "users"

# --- MongoDB Document Field Mappings ---
# These specify which fields in your MongoDB documents contain user data
# Adjust these if your schema uses different field names

# Field containing the username (used for login)
AuthMongoDocumentFieldUsername  "username"

# Field containing the password (hashed value)
AuthMongoDocumentFieldPassword  "password"

# Field containing the user ID (stored as string, e.g., "1001")
AuthMongoDocumentFieldUid       "uid"

# Field containing the group ID (stored as string, e.g., "1001")
AuthMongoDocumentFieldGid       "gid"

# Field containing the home directory path (e.g., "/home/testuser")
AuthMongoDocumentFieldPath      "home_directory"

# --- Error Messages ---
# Custom messages shown to clients on authentication failure

# Message shown when username/password is incorrect or user not found
AuthMongoNoAuthString           "Your username/password is incorrect"

# Message shown when MongoDB connection fails
AuthMongoNoConnectionString     "Failed to connect to Authentication Server"

# --- Password Hashing ---

# Password hash method used in MongoDB
# Options: plain, bcrypt, crypt, sha256, sha512
# - plain: Plain text passwords (NOT RECOMMENDED for production)
# - bcrypt: bcrypt hashes (e.g., $2b$10$...) - RECOMMENDED
# - crypt: Traditional Unix crypt (DES, MD5)
# - sha256: SHA-256 crypt (e.g., $5$...)
# - sha512: SHA-512 crypt (e.g., $6$...)
# The module auto-detects the hash format from the stored hash
AuthMongoPasswordHashMethod     bcrypt

# --- Connection Pool Settings ---

# Maximum size of MongoDB connection pool (1-100)
# Higher values support more concurrent users but use more memory
# Default: 50 (increased from 10 to handle parallel SFTP connections)
#
# IMPORTANT FOR SFTP: SFTP clients often open multiple parallel connections
# for file transfers. Each connection requires a MongoDB client from the pool.
# Symptoms of pool exhaustion:
#   - "Failed to get MongoDB client from pool" errors
#   - Connection delays/timeouts
#   - Some transfers fail while others succeed
#
# Recommended values based on usage:
# - Light usage (1-5 concurrent clients):     10-20
# - Medium usage (5-15 concurrent clients):   20-40
# - Heavy usage (15+ concurrent clients):     40-80
# - Parallel SFTP uploads (multiple files):   50+ (recommended)
#
# Formula: (max concurrent SFTP clients × 5) + 10 = pool size
# Example: 10 clients with parallel uploads = (10 × 5) + 10 = 60
#
# OPTIONAL: Comment out to use default value of 50
AuthMongoConnectionPoolSize     50

# --- Debug Settings ---

# Enable verbose logging for troubleshooting (yes/no)
# Set to "no" in production for better performance
AuthMongoDebugLogging           yes

# ============================================================================
# SFTP CONFIGURATION
# ============================================================================

# Enable SFTP engine
SFTPEngine                      on

# SFTP authentication method (password from MongoDB)
SFTPAuthMethods                 password

# SFTP Options
SFTPOptions IgnoreSFTPUploadPerms IgnoreSCPUploadPerms IgnoreSFTPSetOwners IgnoreSFTPSetExtendedAttributes IgnoreSFTPUploadExtendedAttributes

# SFTP Compression
SFTPCompression                 on

# Maximum SFTP channels
SFTPMaxChannels                 10

# Don't require valid shell for SFTP users
RequireValidShell               off

# --- SFTP Host Keys ---
# Generate these with: ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key -N ""
# You need at least one host key for SFTP to work
SFTPHostKey                     /etc/ssh/ssh_host_rsa_key
SFTPHostKey                     /etc/ssh/ssh_host_ecdsa_key

# ============================================================================
# MONGODB DOCUMENT SCHEMA REFERENCE
# ============================================================================
#
# Your MongoDB collection should contain documents like this:
#
# WITH BCRYPT (Recommended):
# {
#   "_id": ObjectId("674f1234567890abcdef1234"),
#   "username": "testuser",
#   "password": "$2b$10$N9qo8uLOickgx2ZMRZoMye.Ik3JSk5U5p7L6Km1hp7RmWfXfGOIJy",
#   "uid": "1001",
#   "gid": "1001", 
#   "home_directory": "/home/testuser"
# }
#
# WITH PLAIN TEXT (Not Recommended):
# {
#   "_id": ObjectId("674f1234567890abcdef1234"),
#   "username": "testuser",
#   "password": "testpassword",
#   "uid": "1001",
#   "gid": "1001", 
#   "home_directory": "/home/testuser"
# }
#
# IMPORTANT NOTES:
# - All fields are REQUIRED (authentication fails if any are missing)
# - "username" must be unique
# - "password" format depends on AuthMongoPasswordHashMethod:
#   * plain: Plain text password string
#   * bcrypt: bcrypt hash starting with $2a$, $2b$, or $2y$ (from Node.js bcrypt)
#   * sha512: SHA-512 crypt hash starting with $6$
#   * sha256: SHA-256 crypt hash starting with $5$
#   * crypt: Traditional Unix crypt hash
# - "uid" and "gid" are STRINGS (will be converted to integers)
# - "home_directory" must be an absolute path
# - The directory must exist with proper ownership before user can login
#
# GENERATE PASSWORD HASHES:
# 
# For bcrypt (using Node.js):
#   const bcrypt = require('bcrypt');
#   const salt = await bcrypt.genSalt(10);
#   const hash = await bcrypt.hash('yourpassword', salt);
#   console.log(hash);
#
# For SHA-512 (using command line):
#   mkpasswd -m sha-512 yourpassword
#
# For SHA-256 (using command line):
#   mkpasswd -m sha-256 yourpassword
#
# CREATE USER HOME DIRECTORIES:
# For each user, run:
#   sudo mkdir -p /home/testuser
#   sudo chown 1001:1001 /home/testuser
#   sudo chmod 755 /home/testuser
#
# ============================================================================
# TESTING YOUR CONFIGURATION
# ============================================================================
#
# 1. Check syntax:
#    proftpd -t -c /etc/proftpd/proftpd.conf
#
# 2. Test with debug logging enabled (see AuthMongoDebugLogging above)
#
# 3. Monitor logs while testing:
#    tail -f /var/log/proftpd/system.log
#
# 4. Test FTP connection:
#    ftp localhost
#    (enter username and password from MongoDB)
#
# 5. Test SFTP connection:
#    sftp -P 2222 testuser@localhost
#
# 6. Verify user is jailed:
#    Once connected, try: cd /
#    You should see only the contents of the user's home directory
#
# ============================================================================
